<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³½äº‹è¦å‰‡å»ºç«‹å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            color: #2c3e50;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-icon {
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="datetime-local"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .item-list {
            list-style: none;
        }

        .item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-content {
            flex: 1;
        }

        .item-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .item-detail {
            font-size: 13px;
            color: #7f8c8d;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #95a5a6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- é ‚éƒ¨å°èˆª -->
            <div class="header">
                <h1>{{ eventData.name || 'æ–°è³½äº‹è¦å‰‡å»ºç«‹' }}</h1>
                <div class="header-actions">
                    <button @click="openJSONEditor" class="btn btn-secondary">JSON ç·¨è¼¯å™¨</button>
                    <button @click="exportJSON" class="btn btn-primary">åŒ¯å‡º JSON</button>
                    <button @click="previewEvent" class="btn btn-success">é è¦½å ±åé é¢</button>
                </div>
            </div>

            <!-- åŸºæœ¬è³‡è¨Šå¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">ğŸ“‹</span>
                        åŸºæœ¬è³‡è¨Š
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>è³½äº‹åç¨±</label>
                        <input type="text" v-model="eventData.name" placeholder="ä¾‹å¦‚ï¼š2026å¤§æ¹–è‰è“é¦¬æ‹‰æ¾">
                    </div>
                    <div class="form-group">
                        <label>è³½äº‹ ID</label>
                        <input type="text" v-model="eventData.event_id" placeholder="ä¾‹å¦‚ï¼šdahoo-marathon-2026">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>å ±åé–‹å§‹æ™‚é–“</label>
                        <input type="datetime-local" v-model="eventData.registration_start">
                    </div>
                    <div class="form-group">
                        <label>å ±åçµæŸæ™‚é–“</label>
                        <input type="datetime-local" v-model="eventData.registration_end">
                    </div>
                </div>
            </div>

            <!-- å ±åè²»è¨­å®šå¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">ğŸ’°</span>
                        å ±åè²»è¨­å®š
                    </div>
                    <button @click="showAddRaceType" class="btn btn-primary btn-small">+ æ–°å¢çµ„åˆ¥</button>
                </div>
                <ul class="item-list" v-if="raceTypes.length">
                    <li class="item" v-for="(race, index) in raceTypes" :key="index">
                        <div class="item-content">
                            <div class="item-title">{{ race.name }}</div>
                            <div class="item-detail">NT$ {{ race.price }}</div>
                        </div>
                        <div class="item-actions">
                            <button @click="editRaceType(index)" class="btn btn-primary btn-small">ç·¨è¼¯</button>
                            <button @click="deleteRaceType(index)" class="btn btn-danger btn-small">åˆªé™¤</button>
                        </div>
                    </li>
                </ul>
                <div v-else class="empty-state">
                    å°šæœªæ–°å¢ä»»ä½•çµ„åˆ¥ï¼Œé»æ“Šå³ä¸Šè§’ã€Œæ–°å¢çµ„åˆ¥ã€é–‹å§‹è¨­å®š
                </div>
            </div>

            <!-- é‹è²»è¨­å®šå¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">ğŸšš</span>
                        é‹è²»è¨­å®š
                    </div>
                    <button @click="showAddShipping" class="btn btn-primary btn-small">+ æ–°å¢é‹è²»è¦å‰‡</button>
                </div>
                <ul class="item-list" v-if="shippingRules.length">
                    <li class="item" v-for="(rule, index) in shippingRules" :key="index">
                        <div class="item-content">
                            <div class="item-title">{{ rule.name }}</div>
                            <div class="item-detail">{{ rule.minSize }}-{{ rule.maxSize }}äºº Â· NT$ {{ rule.price }}</div>
                        </div>
                        <div class="item-actions">
                            <button @click="editShipping(index)" class="btn btn-primary btn-small">ç·¨è¼¯</button>
                            <button @click="deleteShipping(index)" class="btn btn-danger btn-small">åˆªé™¤</button>
                        </div>
                    </li>
                </ul>
                <div v-else class="empty-state">
                    å°šæœªæ–°å¢é‹è²»è¦å‰‡
                </div>
            </div>

            <!-- åŠ è³¼é …ç›®å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">ğŸ›ï¸</span>
                        åŠ è³¼é …ç›®
                    </div>
                    <button @click="showAddAddon" class="btn btn-primary btn-small">+ æ–°å¢åŠ è³¼</button>
                </div>
                <ul class="item-list" v-if="addons.length">
                    <li class="item" v-for="(addon, index) in addons" :key="index">
                        <div class="item-content">
                            <div class="item-title">{{ addon.name }}</div>
                            <div class="item-detail">
                                NT$ {{ addon.price }}
                                <span class="badge badge-info">{{ addon.priceType === 'per_person' ? 'æŒ‰äººæ•¸' : 'æŒ‰æ•¸é‡' }}</span>
                                <span class="badge badge-warning" v-if="addon.hasCondition">{{ addon.conditionText }}</span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button @click="editAddon(index)" class="btn btn-primary btn-small">ç·¨è¼¯</button>
                            <button @click="deleteAddon(index)" class="btn btn-danger btn-small">åˆªé™¤</button>
                        </div>
                    </li>
                </ul>
                <div v-else class="empty-state">
                    å°šæœªæ–°å¢åŠ è³¼é …ç›®
                </div>
            </div>

            <!-- å„ªæƒ è¦å‰‡å¡ç‰‡ -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <span class="card-icon">ğŸ</span>
                        å„ªæƒ è¦å‰‡
                    </div>
                    <button @click="showAddDiscount" class="btn btn-primary btn-small">+ æ–°å¢å„ªæƒ </button>
                </div>
                <ul class="item-list" v-if="discounts.length">
                    <li class="item" v-for="(discount, index) in discounts" :key="index">
                        <div class="item-content">
                            <div class="item-title">{{ discount.name }}</div>
                            <div class="item-detail">
                                <span v-if="discount.type === 'percentage'">{{ discount.value }}% æŠ˜æ‰£</span>
                                <span v-else>æŠ˜æ‰£ NT$ {{ discount.value }}</span>
                                <span class="badge badge-info">{{ discount.applyToText || 'å¥—ç”¨åˆ°å ±åè²»' }}</span>
                                <span class="badge badge-warning" v-if="discount.conditionText">{{ discount.conditionText }}</span>
                                <span class="badge badge-warning" v-if="discount.hasExclusion">äº’æ–¥å„ªæƒ </span>
                            </div>
                        </div>
                        <div class="item-actions">
                            <button @click="editDiscount(index)" class="btn btn-primary btn-small">ç·¨è¼¯</button>
                            <button @click="deleteDiscount(index)" class="btn btn-danger btn-small">åˆªé™¤</button>
                        </div>
                    </li>
                </ul>
                <div v-else class="empty-state">
                    å°šæœªæ–°å¢å„ªæƒ è¦å‰‡
                </div>
            </div>

            <!-- æ–°å¢/ç·¨è¼¯çµ„åˆ¥ Modal -->
            <div class="modal" :class="{ active: modals.raceType }">
                <div class="modal-content">
                    <div class="modal-header">{{ editingRaceTypeIndex !== null ? 'ç·¨è¼¯' : 'æ–°å¢' }}çµ„åˆ¥</div>
                    <div class="form-group">
                        <label>çµ„åˆ¥åç¨±</label>
                        <input type="text" v-model="currentRaceType.name" placeholder="ä¾‹å¦‚ï¼šå…¨ç¨‹é¦¬æ‹‰æ¾ (42å…¬é‡Œ)">
                    </div>
                    <div class="form-group">
                        <label>çµ„åˆ¥ä»£ç¢¼</label>
                        <input type="text" v-model="currentRaceType.id" placeholder="ä¾‹å¦‚ï¼šfull_marathon">
                    </div>
                    <div class="form-group">
                        <label>å ±åè²»ï¼ˆå…ƒï¼‰</label>
                        <input type="number" v-model.number="currentRaceType.price" placeholder="1050">
                    </div>
                    <div class="modal-footer">
                        <button @click="closeModal('raceType')" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button @click="saveRaceType" class="btn btn-primary">å„²å­˜</button>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢/ç·¨è¼¯é‹è²» Modal -->
            <div class="modal" :class="{ active: modals.shipping }">
                <div class="modal-content">
                    <div class="modal-header">{{ editingShippingIndex !== null ? 'ç·¨è¼¯' : 'æ–°å¢' }}é‹è²»è¦å‰‡</div>
                    <div class="form-group">
                        <label>è¦å‰‡åç¨±</label>
                        <input type="text" v-model="currentShipping.name" placeholder="ä¾‹å¦‚ï¼šå®…é…é‹è²» (1-2äºº)">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>æœ€å°‘äººæ•¸</label>
                            <input type="number" v-model.number="currentShipping.minSize" placeholder="1">
                        </div>
                        <div class="form-group">
                            <label>æœ€å¤šäººæ•¸</label>
                            <input type="number" v-model.number="currentShipping.maxSize" placeholder="2">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>é‹è²»ï¼ˆå…ƒï¼‰</label>
                        <input type="number" v-model.number="currentShipping.price" placeholder="150">
                    </div>
                    <div class="modal-footer">
                        <button @click="closeModal('shipping')" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button @click="saveShipping" class="btn btn-primary">å„²å­˜</button>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢/ç·¨è¼¯åŠ è³¼ Modal -->
            <div class="modal" :class="{ active: modals.addon }">
                <div class="modal-content">
                    <div class="modal-header">{{ editingAddonIndex !== null ? 'ç·¨è¼¯' : 'æ–°å¢' }}åŠ è³¼é …ç›®</div>
                    <div class="form-group">
                        <label>é …ç›®åç¨±</label>
                        <input type="text" v-model="currentAddon.name" placeholder="ä¾‹å¦‚ï¼šç‰¹å®šæ´»å‹•å‚·å®³éšªæ–¹æ¡ˆA">
                    </div>
                    <div class="form-group">
                        <label>é …ç›®ä»£ç¢¼</label>
                        <input type="text" v-model="currentAddon.id" placeholder="ä¾‹å¦‚ï¼šinsurance_plan_a">
                    </div>
                    <div class="form-group">
                        <label>è¨ˆè²»æ–¹å¼</label>
                        <select v-model="currentAddon.priceType">
                            <option value="per_person">æŒ‰äººæ•¸è¨ˆè²»</option>
                            <option value="per_item">æŒ‰æ•¸é‡è¨ˆè²»</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>å–®åƒ¹ï¼ˆå…ƒï¼‰</label>
                        <input type="number" v-model.number="currentAddon.price" placeholder="91">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" v-model="currentAddon.hasCondition" style="width: auto; margin-right: 5px;">
                            è¨­å®šè³¼è²·æ¢ä»¶
                        </label>
                    </div>
                    <div v-if="currentAddon.hasCondition">
                        <div class="form-group">
                            <label>æ¢ä»¶é¡å‹</label>
                            <select v-model="currentAddon.conditionType">
                                <option value="">è«‹é¸æ“‡æ¢ä»¶</option>
                                <option value="race_type">ç‰¹å®šçµ„åˆ¥æ‰èƒ½è³¼è²·</option>
                                <option value="age">å¹´é½¡é™åˆ¶</option>
                            </select>
                        </div>
                        <div class="form-group" v-if="currentAddon.conditionType === 'race_type'">
                            <label>é©ç”¨çµ„åˆ¥ï¼ˆå¯å¤šé¸ï¼‰</label>
                            <select v-model="currentAddon.conditionRaceTypes" multiple style="height: 100px;">
                                <option v-for="race in raceTypes" :key="race.id" :value="race.id">{{ race.name }}</option>
                            </select>
                        </div>
                        <div v-if="currentAddon.conditionType === 'age'">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>æœ€å°å¹´é½¡</label>
                                    <input type="number" v-model.number="currentAddon.conditionAgeMin" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label>æœ€å¤§å¹´é½¡</label>
                                    <input type="number" v-model.number="currentAddon.conditionAgeMax" placeholder="999">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button @click="closeModal('addon')" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button @click="saveAddon" class="btn btn-primary">å„²å­˜</button>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢/ç·¨è¼¯å„ªæƒ  Modal -->
            <div class="modal" :class="{ active: modals.discount }">
                <div class="modal-content">
                    <div class="modal-header">{{ editingDiscountIndex !== null ? 'ç·¨è¼¯' : 'æ–°å¢' }}å„ªæƒ è¦å‰‡</div>
                    <div class="form-group">
                        <label>å„ªæƒ åç¨±</label>
                        <input type="text" v-model="currentDiscount.name" placeholder="ä¾‹å¦‚ï¼šé•·è·é›¢å„ªæƒ ">
                    </div>
                    <div class="form-group">
                        <label>å„ªæƒ é¡å‹</label>
                        <select v-model="currentDiscount.type">
                            <option value="percentage">ç™¾åˆ†æ¯”æŠ˜æ‰£</option>
                            <option value="fixed">å›ºå®šé‡‘é¡æŠ˜æ‰£</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label v-if="currentDiscount.type === 'percentage'">æŠ˜æ‰£ç™¾åˆ†æ¯”ï¼ˆä¾‹å¦‚ï¼š10 ä»£è¡¨ 10% offï¼‰</label>
                        <label v-else>æŠ˜æ‰£é‡‘é¡ï¼ˆå…ƒï¼‰</label>
                        <input type="number" v-model.number="currentDiscount.value" placeholder="10">
                    </div>

                    <div class="form-group">
                        <label>å¥—ç”¨åˆ°</label>
                        <select v-model="currentDiscount.applyTo">
                            <option value="registration_fee">å ±åè²»</option>
                            <option value="total">ç¸½é‡‘é¡</option>
                            <option value="addon:*">æ‰€æœ‰åŠ è³¼é …ç›®</option>
                            <option value="custom">è‡ªè¨‚é …ç›®</option>
                        </select>
                    </div>
                    <div class="form-group" v-if="currentDiscount.applyTo === 'custom'">
                        <label>é¸æ“‡å¥—ç”¨é …ç›®ï¼ˆå¯å¤šé¸ï¼‰</label>
                        <select v-model="currentDiscount.applyToCustom" multiple style="height: 100px;">
                            <option value="registration_fee">å ±åè²»</option>
                            <option v-for="addon in addons" :key="addon.id" :value="'addon:' + addon.id">{{ addon.name }}</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>é©ç”¨æ¢ä»¶</label>
                        <select v-model="currentDiscount.condition">
                            <option value="">ç„¡æ¢ä»¶é©ç”¨</option>
                            <option value="race_type">ç‰¹å®šçµ„åˆ¥</option>
                            <option value="min_amount">æœ€ä½æ¶ˆè²»é‡‘é¡</option>
                            <option value="early_bird">æ—©é³¥å„ªæƒ ï¼ˆæ™‚é–“é™åˆ¶ï¼‰</option>
                        </select>
                    </div>
                    <div class="form-group" v-if="currentDiscount.condition === 'race_type'">
                        <label>é©ç”¨çµ„åˆ¥ï¼ˆå¯å¤šé¸ï¼‰</label>
                        <select v-model="currentDiscount.raceTypes" multiple style="height: 100px;">
                            <option v-for="race in raceTypes" :key="race.id" :value="race.id">{{ race.name }}</option>
                        </select>
                    </div>
                    <div class="form-group" v-if="currentDiscount.condition === 'min_amount'">
                        <label>æœ€ä½é‡‘é¡ï¼ˆå…ƒï¼‰</label>
                        <input type="number" v-model.number="currentDiscount.minAmount" placeholder="2000">
                    </div>
                    <div class="form-group" v-if="currentDiscount.condition === 'early_bird'">
                        <label>å„ªæƒ æˆªæ­¢æ—¥æœŸ</label>
                        <input type="datetime-local" v-model="currentDiscount.earlyBirdDate">
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" v-model="currentDiscount.hasExclusion" style="width: auto; margin-right: 5px;">
                            è¨­å®šäº’æ–¥å„ªæƒ ï¼ˆä¸å¯èˆ‡å…¶ä»–å„ªæƒ åŒæ™‚ä½¿ç”¨ï¼‰
                        </label>
                    </div>
                    <div class="form-group" v-if="currentDiscount.hasExclusion">
                        <label>ä¸å¯åŒæ™‚ä½¿ç”¨çš„å„ªæƒ ï¼ˆå¯å¤šé¸ï¼‰</label>
                        <select v-model="currentDiscount.excludedDiscounts" multiple style="height: 100px;">
                            <option v-for="(d, idx) in discounts" :key="idx" :value="'discount_' + idx">{{ d.name }}</option>
                        </select>
                    </div>

                    <div class="modal-footer">
                        <button @click="closeModal('discount')" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button @click="saveDiscount" class="btn btn-primary">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    eventData: {
                        name: '',
                        event_id: '',
                        registration_start: '',
                        registration_end: ''
                    },
                    raceTypes: [],
                    shippingRules: [],
                    addons: [],
                    discounts: [],
                    modals: {
                        raceType: false,
                        shipping: false,
                        addon: false,
                        discount: false
                    },
                    currentRaceType: { name: '', id: '', price: 0 },
                    currentShipping: { name: '', minSize: 1, maxSize: 2, price: 0 },
                    currentAddon: {
                        name: '',
                        id: '',
                        priceType: 'per_person',
                        price: 0,
                        hasCondition: false,
                        conditionType: '',
                        conditionRaceTypes: [],
                        conditionAgeMin: 0,
                        conditionAgeMax: 999
                    },
                    currentDiscount: {
                        name: '',
                        type: 'percentage',
                        value: 0,
                        condition: '',
                        raceTypes: [],
                        minAmount: 0,
                        dateCondition: '',
                        earlyBirdDate: '',
                        applyTo: 'registration_fee',
                        applyToCustom: [],
                        hasExclusion: false,
                        excludedDiscounts: []
                    },
                    editingRaceTypeIndex: null,
                    editingShippingIndex: null,
                    editingAddonIndex: null,
                    editingDiscountIndex: null
                };
            },
            methods: {
                showAddRaceType() {
                    this.currentRaceType = { name: '', id: '', price: 0 };
                    this.editingRaceTypeIndex = null;
                    this.modals.raceType = true;
                },
                editRaceType(index) {
                    this.currentRaceType = { ...this.raceTypes[index] };
                    this.editingRaceTypeIndex = index;
                    this.modals.raceType = true;
                },
                saveRaceType() {
                    if (this.editingRaceTypeIndex !== null) {
                        this.raceTypes[this.editingRaceTypeIndex] = { ...this.currentRaceType };
                    } else {
                        this.raceTypes.push({ ...this.currentRaceType });
                    }
                    this.closeModal('raceType');
                },
                deleteRaceType(index) {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤çµ„åˆ¥å—ï¼Ÿ')) {
                        this.raceTypes.splice(index, 1);
                    }
                },
                showAddShipping() {
                    this.currentShipping = { name: '', minSize: 1, maxSize: 2, price: 0 };
                    this.editingShippingIndex = null;
                    this.modals.shipping = true;
                },
                editShipping(index) {
                    this.currentShipping = { ...this.shippingRules[index] };
                    this.editingShippingIndex = index;
                    this.modals.shipping = true;
                },
                saveShipping() {
                    if (this.editingShippingIndex !== null) {
                        this.shippingRules[this.editingShippingIndex] = { ...this.currentShipping };
                    } else {
                        this.shippingRules.push({ ...this.currentShipping });
                    }
                    this.closeModal('shipping');
                },
                deleteShipping(index) {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é‹è²»è¦å‰‡å—ï¼Ÿ')) {
                        this.shippingRules.splice(index, 1);
                    }
                },
                showAddAddon() {
                    this.currentAddon = {
                        name: '',
                        id: '',
                        priceType: 'per_person',
                        price: 0,
                        hasCondition: false,
                        conditionType: '',
                        conditionRaceTypes: [],
                        conditionAgeMin: 0,
                        conditionAgeMax: 999
                    };
                    this.editingAddonIndex = null;
                    this.modals.addon = true;
                },
                editAddon(index) {
                    this.currentAddon = { ...this.addons[index] };
                    // ç¢ºä¿é™£åˆ—å±¬æ€§æ­£ç¢ºè¤‡è£½
                    if (this.addons[index].conditionRaceTypes) {
                        this.currentAddon.conditionRaceTypes = [...this.addons[index].conditionRaceTypes];
                    }
                    this.editingAddonIndex = index;
                    this.modals.addon = true;
                },
                saveAddon() {
                    const addon = { ...this.currentAddon };

                    // ç”Ÿæˆæ¢ä»¶æ–‡å­—
                    if (addon.hasCondition) {
                        if (addon.conditionType === 'race_type' && addon.conditionRaceTypes.length) {
                            const raceNames = addon.conditionRaceTypes.map(id => {
                                const race = this.raceTypes.find(r => r.id === id);
                                return race ? race.name : id;
                            });
                            addon.conditionText = 'é™å®šï¼š' + raceNames.join('ã€');
                        } else if (addon.conditionType === 'age') {
                            addon.conditionText = `å¹´é½¡ ${addon.conditionAgeMin}-${addon.conditionAgeMax} æ­²`;
                        }
                    }

                    if (this.editingAddonIndex !== null) {
                        this.addons[this.editingAddonIndex] = addon;
                    } else {
                        this.addons.push(addon);
                    }
                    this.closeModal('addon');
                },
                deleteAddon(index) {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤åŠ è³¼é …ç›®å—ï¼Ÿ')) {
                        this.addons.splice(index, 1);
                    }
                },
                showAddDiscount() {
                    this.currentDiscount = {
                        name: '',
                        type: 'percentage',
                        value: 0,
                        condition: '',
                        raceTypes: [],
                        minAmount: 0,
                        dateCondition: '',
                        earlyBirdDate: '',
                        applyTo: 'registration_fee',
                        applyToCustom: [],
                        hasExclusion: false,
                        excludedDiscounts: []
                    };
                    this.editingDiscountIndex = null;
                    this.modals.discount = true;
                },
                editDiscount(index) {
                    this.currentDiscount = { ...this.discounts[index] };
                    // ç¢ºä¿é™£åˆ—å±¬æ€§æ­£ç¢ºè¤‡è£½
                    if (this.discounts[index].raceTypes) {
                        this.currentDiscount.raceTypes = [...this.discounts[index].raceTypes];
                    }
                    if (this.discounts[index].applyToCustom) {
                        this.currentDiscount.applyToCustom = [...this.discounts[index].applyToCustom];
                    }
                    if (this.discounts[index].excludedDiscounts) {
                        this.currentDiscount.excludedDiscounts = [...this.discounts[index].excludedDiscounts];
                    }
                    this.editingDiscountIndex = index;
                    this.modals.discount = true;
                },
                saveDiscount() {
                    const discount = { ...this.currentDiscount };

                    // ç”Ÿæˆå¥—ç”¨ç›®æ¨™æ–‡å­—
                    if (discount.applyTo === 'registration_fee') {
                        discount.applyToText = 'å ±åè²»';
                    } else if (discount.applyTo === 'total') {
                        discount.applyToText = 'ç¸½é‡‘é¡';
                    } else if (discount.applyTo === 'addon:*') {
                        discount.applyToText = 'æ‰€æœ‰åŠ è³¼';
                    } else if (discount.applyTo === 'custom' && discount.applyToCustom.length) {
                        const items = discount.applyToCustom.map(item => {
                            if (item === 'registration_fee') return 'å ±åè²»';
                            const addon = this.addons.find(a => 'addon:' + a.id === item);
                            return addon ? addon.name : item;
                        });
                        discount.applyToText = items.join('ã€');
                    }

                    // ç”Ÿæˆæ¢ä»¶æ–‡å­—
                    if (discount.condition === 'race_type' && discount.raceTypes.length) {
                        const raceNames = discount.raceTypes.map(id => {
                            const race = this.raceTypes.find(r => r.id === id);
                            return race ? race.name : id;
                        });
                        discount.conditionText = 'é™å®šï¼š' + raceNames.join('ã€');
                    } else if (discount.condition === 'min_amount') {
                        discount.conditionText = `æ»¿ ${discount.minAmount} å…ƒ`;
                    } else if (discount.condition === 'early_bird') {
                        const date = new Date(discount.earlyBirdDate);
                        discount.conditionText = `æ—©é³¥ï¼š${date.toLocaleDateString()}å‰`;
                    }

                    if (this.editingDiscountIndex !== null) {
                        this.discounts[this.editingDiscountIndex] = discount;
                    } else {
                        this.discounts.push(discount);
                    }
                    this.closeModal('discount');
                },
                deleteDiscount(index) {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å„ªæƒ è¦å‰‡å—ï¼Ÿ')) {
                        this.discounts.splice(index, 1);
                    }
                },
                closeModal(type) {
                    this.modals[type] = false;
                },
                exportJSON() {
                    const dsl = this.generateDSL();
                    const json = JSON.stringify(dsl, null, 2);

                    // ä¸‹è¼‰ JSON æª”æ¡ˆ
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${this.eventData.event_id || 'event'}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                previewEvent() {
                    const dsl = this.generateDSL();
                    localStorage.setItem('preview_rules', JSON.stringify(dsl));
                    window.open('/preview', '_blank');
                },
                openJSONEditor() {
                    const dsl = this.generateDSL();
                    localStorage.setItem('builder_data', JSON.stringify(dsl));
                    window.location.href = '/editor';
                },
                generateDSL() {
                    const dsl = {
                        event_id: this.eventData.event_id || 'new-event',
                        version: '1.0',
                        name: this.eventData.name || 'æ–°è³½äº‹',
                        pricing_rules: [],
                        validation_rules: [],
                        form_schema: {
                            fields: []
                        }
                    };

                    let priority = 0;

                    // ç”Ÿæˆè³½äº‹çµ„åˆ¥è¦å‰‡
                    this.raceTypes.forEach(race => {
                        dsl.pricing_rules.push({
                            id: `${race.id}_registration`,
                            priority: priority++,
                            description: `${race.name}å ±åè²»`,
                            condition: {
                                type: 'equals',
                                field: 'user.race_type',
                                value: race.id
                            },
                            action: {
                                type: 'set_price',
                                item: 'registration_fee',
                                value: race.price,
                                label: race.name
                            }
                        });
                    });

                    // ç”Ÿæˆé‹è²»è¦å‰‡
                    priority = 10;
                    this.shippingRules.forEach((rule, idx) => {
                        const conditions = [];
                        conditions.push({
                            type: 'compare',
                            field: 'team_size',
                            operator: '>=',
                            value: rule.minSize
                        });
                        if (rule.maxSize) {
                            conditions.push({
                                type: 'compare',
                                field: 'team_size',
                                operator: '<=',
                                value: rule.maxSize
                            });
                        }

                        dsl.pricing_rules.push({
                            id: `shipping_${idx}`,
                            priority: priority++,
                            description: rule.name,
                            condition: conditions.length > 1 ? {
                                type: 'and',
                                conditions: conditions
                            } : conditions[0],
                            action: {
                                type: 'add_item',
                                item: 'addon:shipping',
                                fixed_price: rule.price,
                                label: rule.name
                            }
                        });
                    });

                    // ç”ŸæˆåŠ è³¼é …ç›®è¦å‰‡
                    priority = 20;
                    this.addons.forEach(addon => {
                        // å»ºç«‹åŸºç¤æ¢ä»¶ï¼šä½¿ç”¨è€…å‹¾é¸äº†æ­¤åŠ è³¼
                        const baseCondition = {
                            type: 'equals',
                            field: `addons.${addon.id}`,
                            value: true
                        };

                        let finalCondition = baseCondition;

                        // å¦‚æœæœ‰è³¼è²·æ¢ä»¶ï¼Œçµ„åˆæ¢ä»¶
                        if (addon.hasCondition && addon.conditionType) {
                            const conditions = [baseCondition];

                            if (addon.conditionType === 'race_type' && addon.conditionRaceTypes && addon.conditionRaceTypes.length) {
                                if (addon.conditionRaceTypes.length === 1) {
                                    conditions.push({
                                        type: 'equals',
                                        field: 'user.race_type',
                                        value: addon.conditionRaceTypes[0]
                                    });
                                } else {
                                    conditions.push({
                                        type: 'or',
                                        conditions: addon.conditionRaceTypes.map(raceId => ({
                                            type: 'equals',
                                            field: 'user.race_type',
                                            value: raceId
                                        }))
                                    });
                                }
                            } else if (addon.conditionType === 'age') {
                                const ageConditions = [];
                                if (addon.conditionAgeMin > 0) {
                                    ageConditions.push({
                                        type: 'compare',
                                        field: 'user.age',
                                        operator: '>=',
                                        value: addon.conditionAgeMin
                                    });
                                }
                                if (addon.conditionAgeMax < 999) {
                                    ageConditions.push({
                                        type: 'compare',
                                        field: 'user.age',
                                        operator: '<=',
                                        value: addon.conditionAgeMax
                                    });
                                }
                                if (ageConditions.length > 0) {
                                    conditions.push(ageConditions.length === 1 ? ageConditions[0] : {
                                        type: 'and',
                                        conditions: ageConditions
                                    });
                                }
                            }

                            finalCondition = conditions.length > 1 ? {
                                type: 'and',
                                conditions: conditions
                            } : baseCondition;
                        }

                        dsl.pricing_rules.push({
                            id: `addon_${addon.id}`,
                            priority: priority++,
                            description: addon.name,
                            condition: finalCondition,
                            action: {
                                type: 'add_item',
                                item: `addon:${addon.id}`,
                                [addon.priceType === 'per_person' ? 'unit_price' : 'unit_price']: addon.price,
                                [addon.priceType === 'per_person' ? 'quantity_field' : 'quantity_field']: addon.priceType === 'per_person' ? 'team_size' : `addons.${addon.id}_quantity`,
                                label: addon.name
                            }
                        });
                    });

                    // ç”Ÿæˆå„ªæƒ è¦å‰‡
                    priority = 100;
                    this.discounts.forEach((discount, idx) => {
                        let condition = { type: 'always_true' };

                        // å»ºç«‹æ¢ä»¶
                        if (discount.condition === 'race_type' && discount.raceTypes && discount.raceTypes.length) {
                            if (discount.raceTypes.length === 1) {
                                condition = {
                                    type: 'equals',
                                    field: 'user.race_type',
                                    value: discount.raceTypes[0]
                                };
                            } else {
                                condition = {
                                    type: 'or',
                                    conditions: discount.raceTypes.map(raceId => ({
                                        type: 'equals',
                                        field: 'user.race_type',
                                        value: raceId
                                    }))
                                };
                            }
                        } else if (discount.condition === 'min_amount') {
                            // éœ€è¦ computed field
                            if (!dsl.computed_fields) {
                                dsl.computed_fields = {};
                            }
                            dsl.computed_fields.subtotal = {
                                type: 'sum_prices',
                                items: ['registration_fee', 'addon:*'],
                                description: 'å°è¨ˆ'
                            };

                            condition = {
                                type: 'compare',
                                field: '$computed.subtotal',
                                operator: '>=',
                                value: discount.minAmount
                            };
                        } else if (discount.condition === 'early_bird' && discount.earlyBirdDate) {
                            condition = {
                                type: 'datetime_before',
                                field: 'register_date',
                                value: new Date(discount.earlyBirdDate).toISOString()
                            };
                        }

                        // æ±ºå®šå¥—ç”¨ç›®æ¨™
                        let applyTo = ['registration_fee'];
                        if (discount.applyTo === 'total') {
                            applyTo = ['total'];
                        } else if (discount.applyTo === 'addon:*') {
                            applyTo = ['addon:*'];
                        } else if (discount.applyTo === 'custom' && discount.applyToCustom && discount.applyToCustom.length) {
                            applyTo = discount.applyToCustom;
                        } else if (discount.applyTo === 'registration_fee') {
                            applyTo = ['registration_fee'];
                        }

                        const rule = {
                            id: `discount_${idx}`,
                            priority: priority++,
                            description: discount.name,
                            condition: condition,
                            action: {
                                type: discount.type === 'percentage' ? 'percentage_discount' : 'fixed_discount',
                                value: discount.value,
                                apply_to: applyTo,
                                label: discount.name
                            }
                        };

                        // åŠ å…¥äº’æ–¥å„ªæƒ è¨»è¨˜ï¼ˆç”¨æ–¼é©—è­‰è¦å‰‡ï¼‰
                        if (discount.hasExclusion && discount.excludedDiscounts && discount.excludedDiscounts.length) {
                            rule.excludes = discount.excludedDiscounts;
                        }

                        dsl.pricing_rules.push(rule);
                    });

                    // ç”Ÿæˆè¡¨å–®æ¬„ä½
                    dsl.form_schema.fields.push(
                        {
                            id: 'name',
                            label: 'å§“å',
                            type: 'text',
                            field: 'user.name',
                            required: true
                        },
                        {
                            id: 'email',
                            label: 'Email',
                            type: 'email',
                            field: 'user.email',
                            required: true
                        }
                    );

                    // è³½äº‹çµ„åˆ¥é¸å–®
                    if (this.raceTypes.length) {
                        dsl.form_schema.fields.push({
                            id: 'race_type',
                            label: 'è³½äº‹çµ„åˆ¥',
                            type: 'select',
                            field: 'user.race_type',
                            required: true,
                            options: [
                                { label: 'è«‹é¸æ“‡çµ„åˆ¥', value: '' },
                                ...this.raceTypes.map(r => ({
                                    label: `${r.name} - NT$${r.price}`,
                                    value: r.id
                                }))
                            ]
                        });
                    }

                    // åœ˜é«”äººæ•¸
                    if (this.shippingRules.length) {
                        dsl.form_schema.fields.push({
                            id: 'team_size',
                            label: 'åœ˜é«”å ±åäººæ•¸',
                            type: 'number',
                            field: 'team_size',
                            default_value: 1,
                            min: 1
                        });
                    }

                    // åŠ è³¼é …ç›®
                    this.addons.forEach(addon => {
                        dsl.form_schema.fields.push({
                            id: addon.id,
                            label: addon.name,
                            type: 'checkbox',
                            field: `addons.${addon.id}`,
                            default_value: false
                        });

                        if (addon.priceType !== 'per_person') {
                            dsl.form_schema.fields.push({
                                id: `${addon.id}_quantity`,
                                label: `${addon.name}æ•¸é‡`,
                                type: 'number',
                                field: `addons.${addon.id}_quantity`,
                                default_value: 1,
                                min: 1
                            });
                        }
                    });

                    // å ±åæ™‚é–“é©—è­‰
                    if (this.eventData.registration_start && this.eventData.registration_end) {
                        dsl.validation_rules.push({
                            id: 'registration_period',
                            description: 'å ±åæ™‚é–“é™åˆ¶',
                            condition: {
                                type: 'not',
                                condition: {
                                    type: 'datetime_between',
                                    field: 'register_date',
                                    start: new Date(this.eventData.registration_start).toISOString(),
                                    end: new Date(this.eventData.registration_end).toISOString()
                                }
                            },
                            error_type: 'blocking',
                            error_message: 'ç›®å‰ä¸åœ¨å ±åæ™‚é–“å…§'
                        });
                    }

                    return dsl;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
